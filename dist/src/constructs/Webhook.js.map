{
  "version": 3,
  "sources": ["../../../src/constructs/Webhook.ts"],
  "sourcesContent": ["import { Construct as CdkConstruct, CfnOutput, Fn } from \"@aws-cdk/core\";\nimport { CfnAuthorizer, CfnIntegration, CfnRoute, HttpApi } from \"@aws-cdk/aws-apigatewayv2\";\nimport { Function } from \"@aws-cdk/aws-lambda\";\nimport { EventBus } from \"@aws-cdk/aws-events\";\nimport { FromSchema } from \"json-schema-to-ts\";\nimport { PolicyDocument, PolicyStatement, Role, ServicePrincipal } from \"@aws-cdk/aws-iam\";\nimport AwsProvider from \"../classes/AwsProvider\";\nimport Construct from \"../classes/Construct\";\n\nexport const WEBHOOK_DEFINITION = {\n    type: \"object\",\n    properties: {\n        type: { const: \"webhook\" },\n        authorizer: {\n            type: \"object\",\n            properties: {\n                handler: { type: \"string\" },\n            },\n            required: [\"handler\"],\n            additionalProperties: true,\n        },\n        insecure: { type: \"boolean\" },\n        path: { type: \"string\" },\n        eventType: { type: \"string\" },\n    },\n    required: [\"path\"],\n    additionalProperties: false,\n} as const;\nconst WEBHOOK_DEFAULTS = {\n    insecure: false,\n};\n\nexport class Webhook extends CdkConstruct implements Construct {\n    private readonly bus: EventBus;\n    private readonly apiEndpointOutput: CfnOutput;\n    private readonly endpointPathOutput: CfnOutput;\n\n    constructor(\n        scope: CdkConstruct,\n        private readonly id: string,\n        private readonly configuration: FromSchema<typeof WEBHOOK_DEFINITION>,\n        private readonly provider: AwsProvider\n    ) {\n        super(scope, id);\n\n        const api = new HttpApi(this, \"HttpApi\");\n        this.apiEndpointOutput = new CfnOutput(this, \"HttpApiEndpoint\", {\n            value: api.apiEndpoint,\n        });\n        const bus = new EventBus(this, \"Bus\");\n        this.bus = bus;\n        const apiGatewayRole = new Role(this, \"ApiGatewayRole\", {\n            assumedBy: new ServicePrincipal(\"apigateway.amazonaws.com\"),\n            inlinePolicies: {\n                EventBridge: new PolicyDocument({\n                    statements: [\n                        new PolicyStatement({\n                            actions: [\"events:PutEvents\"],\n                            resources: [bus.eventBusArn],\n                        }),\n                    ],\n                }),\n            },\n        });\n\n        const resolvedConfiguration = Object.assign({}, WEBHOOK_DEFAULTS, configuration);\n        if (resolvedConfiguration.insecure && resolvedConfiguration.authorizer !== undefined) {\n            throw new Error(\n                `Webhook ${id} is specified as insecure, however an authorizer is configured for this webhook. ` +\n                    \"Either declare this webhook as secure by removing `insecure: true` property (recommended), \" +\n                    \"or specify the webhook as insecure and remove the authorizer property altogether.\"\n            );\n        }\n        if (!resolvedConfiguration.insecure && resolvedConfiguration.authorizer === undefined) {\n            throw new Error(\n                `Webhook ${id} is specified as secure, however no authorizer is configured for this webhook. ` +\n                    \"Please provide an authorizer property for this webhook (recommended), \" +\n                    \"or specify the webhook as insecure by adding `insecure: true` property.\"\n            );\n        }\n\n        const eventBridgeIntegration = new CfnIntegration(this, \"Integration\", {\n            apiId: api.apiId,\n            connectionType: \"INTERNET\",\n            credentialsArn: apiGatewayRole.roleArn,\n            integrationSubtype: \"EventBridge-PutEvents\",\n            integrationType: \"AWS_PROXY\",\n            payloadFormatVersion: \"1.0\",\n            requestParameters: {\n                DetailType: resolvedConfiguration.eventType ?? \"Webhook\",\n                Detail: \"$request.body\",\n                Source: id,\n                EventBusName: bus.eventBusName,\n            },\n        });\n        const route = new CfnRoute(this, \"Route\", {\n            apiId: api.apiId,\n            routeKey: `POST ${resolvedConfiguration.path}`,\n            target: Fn.join(\"/\", [\"integrations\", eventBridgeIntegration.ref]),\n            authorizationType: \"NONE\",\n        });\n\n        if (!resolvedConfiguration.insecure) {\n            const lambda = Function.fromFunctionArn(\n                this,\n                \"LambdaAuthorizer\",\n                (Fn.getAtt(provider.naming.getLambdaLogicalId(`${id}Authorizer`), \"Arn\") as unknown) as string\n            );\n            lambda.grantInvoke(apiGatewayRole);\n            const authorizer = new CfnAuthorizer(this, \"Authorizer\", {\n                apiId: api.apiId,\n                authorizerPayloadFormatVersion: \"2.0\",\n                authorizerType: \"REQUEST\",\n                name: `${id}-authorizer`,\n                identitySource: [\"$request.header.Authorization\"],\n                enableSimpleResponses: true,\n                authorizerUri: Fn.join(\"/\", [\n                    `arn:aws:apigateway:${this.provider.region}:lambda:path/2015-03-31/functions`,\n                    lambda.functionArn,\n                    \"invocations\",\n                ]),\n                authorizerCredentialsArn: apiGatewayRole.roleArn,\n            });\n            route.authorizerId = authorizer.ref;\n            route.authorizationType = \"CUSTOM\";\n        }\n\n        this.endpointPathOutput = new CfnOutput(this, \"Endpoint\", {\n            value: route.routeKey,\n        });\n\n        this.appendFunctions();\n    }\n\n    commands(): Record<string, () => void | Promise<void>> {\n        return {};\n    }\n\n    outputs(): Record<string, () => Promise<string | undefined>> {\n        return {\n            httpMethod: () => this.getHttpMethod(),\n            url: () => this.getUrl(),\n        };\n    }\n\n    references(): Record<string, Record<string, unknown>> {\n        return {\n            busName: this.referenceBusName(),\n        };\n    }\n\n    private appendFunctions(): void {\n        const resolvedWebhookConfiguration = Object.assign({}, WEBHOOK_DEFAULTS, this.configuration);\n        if (resolvedWebhookConfiguration.insecure) {\n            return;\n        }\n        this.provider.addFunction(`${this.id}Authorizer`, resolvedWebhookConfiguration.authorizer);\n    }\n\n    private async getEndpointPath(): Promise<string | undefined> {\n        return this.provider.getStackOutput(this.endpointPathOutput);\n    }\n\n    private async getHttpMethod(): Promise<string | undefined> {\n        const endpointPath = await this.getEndpointPath();\n        if (endpointPath === undefined) {\n            return undefined;\n        }\n        const [httpMethod] = endpointPath.split(\" \");\n\n        return httpMethod;\n    }\n\n    private async getUrl(): Promise<string | undefined> {\n        const apiEndpoint = await this.provider.getStackOutput(this.apiEndpointOutput);\n        if (apiEndpoint === undefined) {\n            return undefined;\n        }\n        const endpointPath = await this.getEndpointPath();\n        if (endpointPath === undefined) {\n            return undefined;\n        }\n        const [, path] = endpointPath.split(\" \");\n\n        return apiEndpoint + path;\n    }\n\n    private referenceBusName(): Record<string, unknown> {\n        return this.provider.getCloudFormationReference(this.bus.eventBusName);\n    }\n}\n"],
  "mappings": "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",
  "names": []
}
